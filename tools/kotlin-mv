#!/bin/bash
set -e

if [ $# -lt 2 ]; then
    echo "Usage:"
    echo "  File move: $0 <source_file> <target_dir> [symbols...]"
    echo "  File rename: $0 <source_file> <target_file.kt> [symbols...]"
    echo "  Symbol only: $0 <old_fully_qualified_name> <new_fully_qualified_name>"
    echo ""
    echo "Examples:"
    echo "  $0 app/src/main/java/net/canvoki/carburoid/ui/settings/LinkPreference.kt app/src/main/java/net/canvoki/shared/component/preferences/"  OtherSymbol ExtraSymbol
    echo "  $0 app/src/main/java/net/canvoki/carburoid/ui/settings/OldName.kt app/src/main/java/net/canvoki/shared/component/preferences/NewName.kt"
    echo "  $0 net.canvoki.carburoid.ui.settings.LinkPreference net.canvoki.shared.component.preferences.LinkPreference"
    exit 1
fi

SOURCE="$1"
TARGET="$2"
shift 2
SYMBOLS=("$@")

# Check if source is a file path or FQN
if [[ "$SOURCE" == *".kt" ]] || [[ "$SOURCE" == *".java" ]] || [[ "$SOURCE" == */* ]]; then
    # File move/rename mode
    SOURCE_FILE="$SOURCE"
    TARGET_PATH="$TARGET"

    if [ ! -f "$SOURCE_FILE" ]; then
        echo "âŒ Source file not found: $SOURCE_FILE"
        exit 1
    fi

    # Extract current package from file
    CURRENT_PKG=$(grep "^package " "$SOURCE_FILE" | head -1 | sed 's/^package //; s/;$//')
    if [ -z "$CURRENT_PKG" ]; then
        echo "âŒ No package declaration found in: $SOURCE_FILE"
        exit 1
    fi

    # Get original filename without extension
    SOURCE_BASENAME=$(basename "$SOURCE_FILE")
    SOURCE_BASENAME="${SOURCE_BASENAME%.*}"

    # Check if target is a directory or file
    if [[ "$TARGET_PATH" == *".kt" ]] || [[ "$TARGET_PATH" == *".java" ]]; then
        # Target is a file (rename mode)
        TARGET_IS_FILE=true
        TARGET_DIR=$(dirname "$TARGET_PATH")
        TARGET_FILENAME=$(basename "$TARGET_PATH")
        TARGET_BASENAME="${TARGET_FILENAME%.*}"

        # Determine target package from directory path
        if [[ "$TARGET_DIR" == *"java/"* ]]; then
            TARGET_PKG_PATH="${TARGET_DIR#*java/}"
            TARGET_PKG=$(echo "$TARGET_PKG_PATH" | tr '/' '.')
        elif [[ "$TARGET_DIR" == *"kotlin/"* ]]; then
            TARGET_PKG_PATH="${TARGET_DIR#*kotlin/}"
            TARGET_PKG=$(echo "$TARGET_PKG_PATH" | tr '/' '.')
        else
            echo "âŒ Target directory should contain 'java/' or 'kotlin/' path"
            exit 1
        fi

        NEW_FILE="$TARGET_PATH"

    else
        # Target is a directory (move mode)
        TARGET_IS_FILE=false
        # Remove trailing slash from target directory
        TARGET_DIR="${TARGET_PATH%/}"
        TARGET_BASENAME="$SOURCE_BASENAME"
        TARGET_FILENAME="$SOURCE_BASENAME.${SOURCE_FILE##*.}"

        # Determine target package from directory path
        if [[ "$TARGET_DIR" == *"java/"* ]]; then
            TARGET_PKG_PATH="${TARGET_DIR#*java/}"
            TARGET_PKG=$(echo "$TARGET_PKG_PATH" | tr '/' '.')
        elif [[ "$TARGET_DIR" == *"kotlin/"* ]]; then
            TARGET_PKG_PATH="${TARGET_DIR#*kotlin/}"
            TARGET_PKG=$(echo "$TARGET_PKG_PATH" | tr '/' '.')
        else
            echo "âŒ Target directory should contain 'java/' or 'kotlin/' path"
            exit 1
        fi

        NEW_FILE="$TARGET_DIR/$TARGET_FILENAME"
    fi

    echo "ðŸ“ Moving/Renaming file:"
    if [ "$TARGET_IS_FILE" = true ]; then
        echo "  From: $SOURCE_FILE"
        echo "  To:   $NEW_FILE (rename)"
        echo "  Old symbol: $SOURCE_BASENAME"
        echo "  New symbol: $TARGET_BASENAME"
    else
        echo "  From: $SOURCE_FILE"
        echo "  To:   $NEW_FILE"
    fi
    echo "  Current package: $CURRENT_PKG"
    echo "  Target package:  $TARGET_PKG"
    echo ""

    # Create target directory
    mkdir -p "$TARGET_DIR"

    # Move/Rename the file
    mv "$SOURCE_FILE" "$NEW_FILE"

    # Update package declaration
    ESCAPED_CURRENT=$(echo "$CURRENT_PKG" | sed 's/\./\\./g')
    sed -i "s/^package $ESCAPED_CURRENT/package $TARGET_PKG/g" "$NEW_FILE"

    # Clean up empty source directories
    SOURCE_DIR=$(dirname "$SOURCE_FILE")
    if [ -d "$SOURCE_DIR" ] && [ -z "$(ls -A "$SOURCE_DIR" 2>/dev/null)" ]; then
        echo "ðŸ§¹ Removing empty directory: $SOURCE_DIR"
        rmdir -p "$SOURCE_DIR" 2>/dev/null || true
    fi

    echo "âœ… File moved/renamed successfully!"

    # Determine symbols to update - COMBINE all sources
    SYMBOLS_TO_UPDATE=()

    # Always include the original symbol (in case it's used elsewhere)
    SYMBOLS_TO_UPDATE+=("$SOURCE_BASENAME")
    echo "ðŸ” Including original symbol: $SOURCE_BASENAME"

    # Include the new symbol if it's different (for rename cases)
    if [ "$TARGET_BASENAME" != "$SOURCE_BASENAME" ]; then
        SYMBOLS_TO_UPDATE+=("$TARGET_BASENAME")
        echo "ðŸ” Including new symbol (rename): $TARGET_BASENAME"
    fi

    # Add any explicitly provided symbols (avoid duplicates)
    for SYMBOL in "${SYMBOLS[@]}"; do
        # Check if symbol is already in the list
        if [[ ! " ${SYMBOLS_TO_UPDATE[*]} " == *" $SYMBOL "* ]]; then
            SYMBOLS_TO_UPDATE+=("$SYMBOL")
            echo "ðŸ” Including explicit symbol: $SYMBOL"
        fi
    done

    # Update symbol references for each specific symbol ONLY
    for SYMBOL in "${SYMBOLS_TO_UPDATE[@]}"; do
        OLD_FQN="$CURRENT_PKG.$SYMBOL"
        NEW_FQN="$TARGET_PKG.$SYMBOL"

        echo ""
        echo "ðŸ”„ Updating symbol references for: $SYMBOL"
        echo "   Old: $OLD_FQN"
        echo "   New: $NEW_FQN"

        # Escape dots for regex
        ESCAPED_OLD_FQN=$(echo "$OLD_FQN" | sed 's/\./\\./g')
        ESCAPED_NEW_FQN=$(echo "$NEW_FQN" | sed 's/\./\\./g')

        # Update explicit FQN references (like SomeClass.method())
        find app/src -name "*.kt" -o -name "*.java" | while read -r file; do
            if grep -q "$ESCAPED_OLD_FQN" "$file" 2>/dev/null; then
                sed -i "s/$ESCAPED_OLD_FQN/$NEW_FQN/g" "$file"
            fi
        done

        # Update specific import statements (only the exact symbol)
        find app/src -name "*.kt" -o -name "*.java" | while read -r file; do
            if grep -q "import $ESCAPED_OLD_FQN" "$file" 2>/dev/null; then
                sed -i "s/import $ESCAPED_OLD_FQN/import $NEW_FQN/g" "$file"
            fi
        done
    done

else
    # Symbol-only mode (FQN to FQN)
    OLD_FQN="$SOURCE"
    NEW_FQN="$TARGET"

    # Validate FQN format
    if [[ ! "$OLD_FQN" == *"."* ]] || [[ ! "$NEW_FQN" == *"."* ]]; then
        echo "âŒ Invalid FQN format. Both arguments must contain dots."
        exit 1
    fi

    echo "ðŸ”„ Symbol-only update:"
    echo "  Old: $OLD_FQN"
    echo "  New: $NEW_FQN"
    echo ""

    # Escape dots for regex
    ESCAPED_OLD_FQN=$(echo "$OLD_FQN" | sed 's/\./\\./g')
    ESCAPED_NEW_FQN=$(echo "$NEW_FQN" | sed 's/\./\\./g')

    # Update explicit FQN references
    find app/src -name "*.kt" -o -name "*.java" | while read -r file; do
        if grep -q "$ESCAPED_OLD_FQN" "$file" 2>/dev/null; then
            sed -i "s/$ESCAPED_OLD_FQN/$NEW_FQN/g" "$file"
        fi
    done

    # Update specific import statements
    find app/src -name "*.kt" -o -name "*.java" | while read -r file; do
        if grep -q "import $ESCAPED_OLD_FQN" "$file" 2>/dev/null; then
            sed -i "s/import $ESCAPED_OLD_FQN/import $NEW_FQN/g" "$file"
        fi
    done

    echo "âœ… Symbol references updated!"
fi

echo ""
echo "ðŸ” Verification:"
if [[ "$SOURCE" == *".kt" ]] || [[ "$SOURCE" == *".java" ]] || [[ "$SOURCE" == */* ]]; then
    # File move mode - check for old FQN references of moved symbols
    FOUND_REFS=false
    for SYMBOL in "${SYMBOLS_TO_UPDATE[@]}"; do
        OLD_FQN="$CURRENT_PKG.$SYMBOL"
        if grep -r "$OLD_FQN" app/src --include="*.kt" --include="*.java" --exclude-dir=".git" --exclude-dir="build" > /dev/null 2>&1; then
            FOUND_REFS=true
            grep -r "$OLD_FQN" app/src --include="*.kt" --include="*.java" --exclude-dir=".git" --exclude-dir="build"
        fi
    done
    if [ "$FOUND_REFS" = false ]; then
        echo "âœ… No remaining references found for moved symbols!"
    fi
else
    # Symbol mode - check for old FQN
    grep -r "$OLD_FQN" app/src --include="*.kt" --include="*.java" --exclude-dir=".git" --exclude-dir="build" || echo "âœ… No remaining references found!"
fi

echo ""
echo "ðŸ’¡ Done! Review changes with: git diff"
